<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Admin Panel</title>

    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>

    <script>
        // Set the default CSS theme and icon library globally
        JSONEditor.defaults.theme = 'spectre';
        JSONEditor.defaults.iconlib = 'spectre';
    </script>
    <style>
        .container {
            max-width: 960px;
            margin: 0 auto
        }
    </style>
</head>

<body>
    <div class='container'>
        <div class='columns'>
            <h1 class='col-md-12'>Hehe</h1>
        </div>
        <div class='columns'>
            <div class='column col-md-6'>
                <p>Add Shoes here</p>
            </div>
        </div>
        <div class='columns'>
            <div class='column col-md-12'>
                <input type="text" id="Token" name="token"><br><br>
                <button id='submit' onclick="publish()" class="btn btn-sm btn-primary">Publish</button>
                <span id='valid_indicator' class='label'></span>
            </div>
        </div>
        <div class='columns'>
            <div class='column col-md-12' id='editor_holder'></div>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        // This is the starting value for the editor
        // We will use this to seed the initial editor 
        // and to provide a "Restore to Default" button.
        // Initialize the editor
        var editor = new JSONEditor(document.getElementById('editor_holder'), {
            // Enable fetching schemas via ajax
            ajax: true,

            // The schema for the editor
            schema: {
                $ref: "shoe.json",
                format: "grid"
            },

            // Seed the form with a starting value

        });
        editor.on('ready', function() {
            $.getJSON("./shoes.json", function(data) {
                editor.setValue(data);
            });
        });

        editor.on('change', function() {
            // Get an array of errors from the validator
            var errors = editor.validate();

            var indicator = document.getElementById('valid_indicator');

            // Not valid
            if (errors.length) {
                indicator.className = 'label alert';
                indicator.textContent = 'not valid';
            }
            // Valid
            else {
                indicator.className = 'label success';
                indicator.textContent = 'valid';
            }
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        function publish() {
            console.log(editor.getValue());
            //https://api.github.com/repos/drakedrac/solegasm/contents/
            let token = document.getElementById("Token").value;
            var content = btoa(JSON.stringify(editor.getValue()));
            console.log(content);
            $.getJSON("https://api.github.com/repos/drakedrac/solegasm/contents/shoes.json", function(data) {
                uploadFileApi(token, content, data.sha)
            });

            function uploadFileApi(token, content, sha) {

                var data = JSON.stringify({
                    "message": "json file",
                    "content": `${content}`,
                    "sha": `${sha}`
                });

                var config = {
                    method: 'put',
                    url: 'https://api.github.com/repos/drakedrac/solegasm/contents/shoes.json',

                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    data: data
                };

                axios(config)
                    .then(function(response) {
                        console.log(JSON.stringify(response.data));
                    })
                    .catch(function(error) {
                        console.log(error);
                    });
            }
        }
    </script>
</body>

</html>